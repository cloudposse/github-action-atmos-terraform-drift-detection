---
#
# This is the canonical configuration for the `README.md`
# Run `make readme` to rebuild the `README.md`
#

name: github-action-atmos-terraform-drift-detection

tags:
  - github-action
  - atmos
  - terraform

# License of this project
license: "APACHE2"

github_repo: cloudposse/github-action-atmos-terraform-drift-detection

badges:
  - name: "Latest Release"
    image: "https://img.shields.io/github/release/cloudposse/github-action-atmos-terraform-drift-detection.svg"
    url: "https://github.com/cloudposse/github-action-atmos-terraform-drift-detection/releases/latest"
  - name: "Slack Community"
    image: "https://slack.cloudposse.com/badge.svg"
    url: "https://slack.cloudposse.com"

related: []

description: This Github Action is used to detect drift

introduction: |-
  This Github Action is used to detect drift.

  It will create or update github issue once drift is detect.

  It is expected to run this action in a workflow with a scheduled run.

  There is another companion action [github-action-atmos-terraform-drift-remediation](https://github.com/cloudposse/github-action-atmos-terraform-drift-remediation).

references:
  - name: "github-action-atmos-terraform-drift-remediation"
    description: "Companion GitHub Action for remediation"
    url: "https://github.com/cloudposse/github-action-atmos-terraform-drift-remediation"
  - name: "github-action-atmos-terraform-select-components"
    description: "Companion GitHub Action to select components that are suitable for drift detection"
    url: "https://github.com/cloudposse/github-action-atmos-terraform-select-components"
  - name: "github-action-terraform-plan"
    description: "GitHub Action to do Terraform Plan"
    url: "https://github.com/cloudposse/github-action-atmos-terraform-plan"
  - name: "github-action-terraform-apply"
    description: "GitHub Action to do Terraform Apply"
    url: "https://github.com/cloudposse/github-action-atmos-terraform-apply"
  - name: "github-action-terraform-plan-storage"
    description: "A GitHub Action to securely store Terraform plan files in an S3 bucket with metadata storage in DynamoDB."
    url: "https://github.com/cloudposse/github-action-terraform-plan-storage"

usage: |-
  ### Workflow example

  ```yaml
  name: ðŸ‘½ Atmos Terraform Drift Detection
  run-name: ðŸ‘½ Atmos Terraform Drift Detection

  on:
    schedule:
      - cron: "0 * * * *"

  permissions:
    id-token: write
    contents: read

  jobs:
    select-components:
      runs-on: ubuntu-latest
      name: Select Components
      outputs:
        matrix: ${{ steps.components.outputs.matrix }}
      steps:
        - name: Selected Components
          id: components
          uses: cloudposse/github-action-atmos-terraform-select-components@v1
          with:
            jq-query: 'to_entries[] | .key as $parent | .value.components.terraform | to_entries[] | select(.value.settings.github.actions_enabled // false) | [$parent, .key] | join(",")'

    plan-atmos-components:
      needs:
        - select-components
      runs-on: ubuntu-latest
      if: ${{ needs.select-components.outputs.matrix != '{"include":[]}' }}
      strategy:
        fail-fast: false # Don't fail fast to avoid locking TF State
        matrix: ${{ fromJson(needs.select-components.outputs.matrix) }}
      name: ${{ matrix.stack_slug }}
      steps:
        - name: Plan Atmos Component
          id: atmos-plan
          uses: cloudposse/github-action-atmos-terraform-plan@v1
          with:
            component: ${{ matrix.component }}
            stack: ${{ matrix.stack }}
            component-path: ${{ matrix.component_path }}
            drift-detection-mode-enabled: "true"
            terraform-plan-role: "arn:aws:iam::111111111111:role/acme-core-gbl-identity-gitops"
            terraform-state-bucket: "acme-core-ue2-auto-gitops"
            terraform-state-role: "arn:aws:iam::999999999999:role/acme-core-ue2-auto-gitops-gha"
            terraform-state-table: "acme-core-ue2-auto-gitops"
            aws-region: "us-east-2"

    drift-detection:
      needs:
        - plan-atmos-components
      runs-on: ubuntu-latest
      outputs:
        components-with-issues: ${{ steps.drift-detection.outputs.components-with-issues }}
        components-without-issues: ${{ steps.drift-detection.outputs.components-without-issues }}
      steps:
        - name: Drift Detection
          id: drift-detection
          uses: cloudposse/github-action-atmos-terraform-drift-detection@v1
          with:
            mode: 'triage'
            max-opened-issues: '3'

    create-gh-issues:
      needs:
        - drift-detection
      runs-on: ubuntu-latest
      if: ${{ needs.drift-detection.outputs.components-without-issues != '{"include":[]}' }}
      strategy:
        fail-fast: false
        matrix: ${{ fromJson(needs.drift-detection.outputs.components-without-issues) }}
      name: ${{ matrix.stackSlug }}
      steps:
        - name: Drift Detection
          uses: cloudposse/github-action-atmos-terraform-drift-detection@v1
          with:
            mode: 'create-gh-issue'
            component: ${{ matrix.component }}
            stack: ${{ matrix.stack }}
            component-path: ${{ matrix.componentPath }}
            issue-title: ${{ matrix.issueTitle }}
            issue-description: ${{ matrix.issueDescription }}

    update-gh-issues:
      needs:
        - drift-detection
      runs-on: ubuntu-latest
      if: ${{ needs.drift-detection.outputs.components-with-issues != '{"include":[]}' }}
      strategy:
        fail-fast: false
        matrix: ${{ fromJson(needs.drift-detection.outputs.components-with-issues) }}
      name: ${{ matrix.stackSlug }}
      steps:
        - name: Drift Detection
          uses: cloudposse/github-action-atmos-terraform-drift-detection@v1
          with:
            mode: 'update-gh-issue'
            component: ${{ matrix.component}}
            stack: ${{ matrix.stack }}
            issue-number: ${{ matrix.issueNumber }}
            issue-description: ${{ matrix.issueDescription }}
            component-path: ${{ matrix.componentPath }}
  ```

include:
  - "docs/github-action.md"

contributors:
  - name: "Zinovii Dmytriv"
    github: "zdmytriv"
  - name: "Erik Osterman"
    github: "osterman"
  - name: "Daniel Miller"
    github: "milldr"
